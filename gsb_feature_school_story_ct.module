<?php
/**
 * @file
 * Code for the GSB Feature School Story feature.
 */

include_once 'gsb_feature_school_story_ct.features.inc';

/**
 * Implements hook_form_alter()
 */
function gsb_feature_school_story_ct_form_alter(&$form, &$form_state, $form_id) {

  // If this is the school story node edit form
  
  if ($form_id == 'gsb_school_story_node_form') {
    
      // If the business insight flag is set to 1
      // then we mark these taxonomy fields are required

      // field_business_insight_topic

      $form['field_business_insight_topic']['und']['#states'] = array(
        'required' => array(
          ':input[name="flag[business_insight_flag]"]' => array(
            array('checked' => TRUE),
          ),
        ),
      );

      // field_discipline

      $form['field_discipline']['und']['#states'] = array(
        'required' => array(
          ':input[name="flag[business_insight_flag]"]' => array(
            array('checked' => TRUE),
          ),
        ),
      );

      // field_industry

      $form['field_industry']['und']['#states'] = array(
        'required' => array(
          ':input[name="flag[business_insight_flag]"]' => array(
            array('checked' => TRUE),
          ),
        ),
      );

      // field_region

      $form['field_region']['und']['#states'] = array(
        'required' => array(
          ':input[name="flag[business_insight_flag]"]' => array(
            array('checked' => TRUE),
          ),
        ),
      );
    
      // We make the byline person reference field visible, 
      // if the reference option has been selected

      $form['field_byline']['und'][0]['field_byline_person_reference']['#states'] = array(
        'visible' => array(
          ':input[name="field_byline[und][' . '0' . '][field_byline_reference][und]"]' => array(
            array('value' => 'UseEntityReference'),
          ),
        ),
      );
    
      // Otherwise, we make the byline first and lastname fields visible, 
      // if the "other" option has been selected

      $form['field_byline']['und'][0]['field_first_name']['#states'] = array(
        'visible' => array(
          ':input[name="field_byline[und][' . '0' . '][field_byline_reference][und]"]' => array(
            array('value' => 'Other'),
          ),
        ),
      );

      $form['field_byline']['und'][0]['field_last_name']['#states'] = array(
        'visible' => array(
          ':input[name="field_byline[und][' . '0' . '][field_byline_reference][und]"]' => array(
            array('value' => 'Other'),
          ),
        ),
      );

      // and we need to handle the form validation for the school story node edit form
    
      $form['#validate'][] = '_gsb_feature_school_story_ct_bi_topic_validate';

  }

}

function _gsb_feature_school_story_ct_bi_topic_validate(&$form, &$form_state) {

  // We check to see if the business insight flag is set to 1
  // and if it is...

  // We check that the following taxonomies have been set to one of the 
  // term values

  if (isset($form_state['values']['flag']['business_insight_flag'])) {
    if ($form_state['values']['flag']['business_insight_flag'] == 1) {

      // field_business_insight_topic

      if (isset($form_state['values']['field_business_insight_topic']['und'][0]['tid'])) {
        if ($form_state['values']['field_business_insight_topic']['und'][0]['tid'] == null) {
          // return error
          form_set_error('', t('Please select a business topic'));
        }
      } else {
        // return error
        form_set_error('', t('Please select a business topic'));
      }

      // field_discipline

      if (isset($form_state['values']['field_discipline']['und'][0]['tid'])) {
        if ($form_state['values']['field_discipline']['und'][0]['tid'] == null) {
          // return error
          form_set_error('', t('Please select a discipline'));
        }
      } else {
        // return error
        form_set_error('', t('Please select a discipline'));
      }

      // field_industry

      if (isset($form_state['values']['field_industry']['und'][0]['tid'])) {
        if ($form_state['values']['field_industry']['und'][0]['tid'] == null) {
          // return error
          form_set_error('', t('Please select an industry'));
        }
      } else {
        // return error
        form_set_error('', t('Please select an industry'));
      }

      // field_region

      if (isset($form_state['values']['field_region']['und'][0]['tid'])) {
        if ($form_state['values']['field_region']['und'][0]['tid'] == null) {
          // return error
          form_set_error('', t('Please select a region'));
        }
      } else {
        // return error
        form_set_error('', t('Please select a region'));
      }

    }
  }

}
